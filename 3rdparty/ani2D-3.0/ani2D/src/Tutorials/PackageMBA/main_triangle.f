C =====================================================================
      Program Main
C =====================================================================
C Read mesh from files generated by code Triangle
C =====================================================================
      implicit none

c Maximum number of nodes, elements and boundary edges
      Integer   nvmax, ntmax, nbmax
      Parameter(nvmax = 20000, nbmax = 10000, ntmax = 2 * nvmax)

c Available memory 
      Integer   MaxWr, MaxWi
      Parameter(MaxWr = 1 000 000, MaxWi = 1 000 000)

C =====================================================================
C group (M)
      Integer  nv, nvfix, labelV(nvmax), fixedV(nvmax)
      Real*8   vrt(2, nvmax)

      Integer  nb, nbfix, bnd(2, nbmax), labelB(nbmax), fixedB(nbmax)

      Integer  nc, labelC(nbmax)
      Real*8   crv(2, nbmax)
      EXTERNAL ANI_CrvFunction

      Integer  nt, ntfix, tri(3, ntmax), labelT(ntmax), fixedT(ntmax)

C group (CONTROL)
      Integer  control(6)
      Real*8   Quality
c The routine which defines the nodal metric
      Integer  MetricFunction
      External MetricFunction

C group (W)
      Real*8  rW(MaxWr)
      Integer iW(MaxWi)


C LOCAL VARIABLES
      Integer  nEStar, iERR

C =====================================================================
c === load the initial mesh. The extension must be .node or .ele
      Call loadMTriangle(nv, nvfix, nvmax, vrt, labelV, fixedV,
     &                   nb, nbfix, nbmax, bnd, labelB, fixedB,
     &                   nc,              Crv, labelC, 
     &                   nt, ntfix, ntmax, tri, labelT, fixedT,
     &                   "../data/triangle/A.ele")


c === draw the initial mesh (no labels of mesh points is available)
c     The name must have extensione with .ps
c     Demo graphics has been activated
c     Call draw(nv,nb,nt, vrt,labelV, bnd,labelB, tri,'mesh_initial.ps')
      Call graph_demo(nv,vrt, nt,tri, 'mesh_initial.ps', 
     &               'Initial mesh generated by code Triangle')


c === generate adaptive mesh
      control(1) = 500     !  MaxSkipE
      control(2) = 50000   !  MaxQItr
      control(3) = 1       !  status
      control(4) = 1       !  flagAuto
      control(5) = 1       !  iPrint:   average level of output information
      control(6) = 0       !  iErrMesgt: only critical termination allowed

      Quality = 0.8D0      !  request shape-regular triangles in metric
      nEStar  = 3000       !  desired number of triangles

      Call mbaAnalytic(
c group (M)
     &      nv, nvfix, nvmax, vrt, labelV, fixedV,
     &      nb, nbfix, nbmax, bnd, labelB, fixedB,
     &      nc,               crv, labelC, ANI_CrvFunction,
     &      nt, ntfix, ntmax, tri, labelT, fixedT,
c group (CONTROL)
     &      nEStar, Quality, control, MetricFunction,
c group (W)
     &      MaxWr, MaxWi, rW, iW, iERR)


c === draw final mesh (mesh routine saved labels of points in iW(1:nv))
c the file name must have extension .ps
c demo graphics has been activated
c     Call draw(nv, nb, nt, vrt, iW, bnd, labelB, tri, 'mesh_final.ps')
      Call graph_demo(nv,vrt, nt,tri, 'mesh_final.ps', 
     &               'Final mesh quasi-uniform in isotropic metric')


c ... save the final mesh. The extension must be .ani
      Call saveMani(nv, nvfix, vrt, labelV, fixedV,
     &              nb, nbfix, bnd, labelB, fixedB,
     &              nc,        crv, labelC, 
     &              nt, ntfix, tri, labelT, fixedT,
     &             "save.ani")


c ... testing the results
      If(Quality.LT.0.65) Stop 911

      Stop
      End



C =====================================================================
      Integer Function MetricFunction(x, y, Metric)
C =====================================================================
C  This routine creates a metric at the given point (x,y). The
C  metric is a 2x2 positive definite symmetric tensor:
C                M11   M12
C      Metric =  
C                M12   M22
C
C  Only the upper triangular part of 2x2 array Metric may be defined.
C  
C  In this example, the metric is constant and isotropic.
C =====================================================================
      Real*8  x, y, Metric(2, 2)

      Metric(1,1) = 1D0
      Metric(2,2) = 1D0
      Metric(1,2) = 0D0

      MetricFunction = 0

      Return
      End




